@inject NavigationManager navigationManager
@inject IDbContextFactory<DataContext> _contextFactory

<div>
    <MudLink @onclick="@(() => NavigateToUser())"
             Typo="Typo.h6"
             Color="Color.Dark"
             Underline="Underline.None">
        @Recipe?.User?.UserName
    </MudLink>
    <p />   
    @Recipe?.Notes
    @if (CanEdit && Editing) {
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" @onclick="() => {
                notesEditOpen = true;                
        }" />
    }
    
</div>
@if (Recipe != null) {
    <MudPopover Open="@notesEditOpen" Fixed="false" Class="px-4 pt-4">
        <div class="d-flex flex-column">
            <MudTextField @bind-Value="Recipe.Notes" Lines="3" />
            <MudIconButton Icon="@Icons.Material.Filled.Save" Class="ml-auto mr-n3 mb-1" Color="Color.Error" @onclick="async () => {
            notesEditOpen = false;
            await UpdateAndSaveRecipe();
        }" />
        </div>
    </MudPopover>
}
@code {

    [CascadingParameter(Name = "RecipeParam")]
    public Recipe? Recipe { get; set; }
    [CascadingParameter(Name = "CanEditParam")]
    public bool CanEdit { get; set; }
    [CascadingParameter(Name = "EditingParam")]
    public bool Editing { get; set; }
    private bool notesEditOpen = false;
    private DataContext? _dataContext;

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        _dataContext = await _contextFactory.CreateDbContextAsync();
    }
    private async Task UpdateAndSaveRecipe() {
        if (Recipe != null) {
            _dataContext.Update(Recipe);
            await _dataContext.SaveChangesAsync();
            StateHasChanged();
        }
    } 
    private void NavigateToUser() {
        navigationManager.NavigateTo("/profile/" + Recipe.User.Id);
    }
}